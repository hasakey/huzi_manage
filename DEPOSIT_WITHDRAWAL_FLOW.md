# 充值和提现流程说明

## ✅ 已实现功能

### 1. 用户端功能

#### 充值功能 (`/dashboard/deposit`)
- **功能**: 用户发起充值请求
- **流程**: 
  1. 用户输入充值金额
  2. 提交充值请求
  3. 创建 `deposit` 类型、`pending` 状态的交易记录
  4. 等待管理员审核

#### 提现功能 (`/dashboard/withdraw`)
- **功能**: 用户发起提现请求
- **流程**:
  1. 用户输入提现金额
  2. 验证余额是否充足
  3. 提交提现请求
  4. 创建 `withdraw` 类型、`pending` 状态的交易记录
  5. 等待管理员审核

#### 交易记录 (`/dashboard/transactions`)
- **功能**: 查看自己的所有充值和提现记录
- **显示内容**:
  - 交易类型（充值/提现）
  - 金额
  - 状态（待审核/已批准/已拒绝）
  - 申请时间
  - 更新时间

### 2. 管理员端功能

#### 交易审核 (`/admin/withdrawals`)
- **功能**: 审核用户的充值和提现请求
- **流程**:
  1. 查看所有待审核的交易（充值和提现）
  2. 点击"审核"按钮查看详情
  3. 选择"批准"或"拒绝"
  4. 批准后：
     - **充值**: 增加用户余额（由数据库触发器自动处理）
     - **提现**: 扣除用户余额（由数据库触发器自动处理）
  5. 拒绝后：仅更新状态，不改变余额

#### 交易记录 (`/admin/transactions`)
- **功能**: 查看所有用户的充值和提现记录
- **显示内容**:
  - 交易类型（充值/提现）
  - 用户信息（姓名、邮箱、手机号）
  - 金额
  - 状态（待审核/已批准/已拒绝）
  - 申请时间
  - 更新时间

## 🔄 数据流程

### 充值流程
```
1. 用户在 /dashboard/deposit 页面输入充值金额
2. 提交充值请求
3. 创建 transactions 记录：
   - type: 'deposit'
   - status: 'pending'
   - amount: 充值金额
4. 管理员在 /admin/withdrawals 页面查看待审核请求
5. 管理员点击"审核"，选择"批准"或"拒绝"
6. 如果批准：
   - 更新状态为 'approved'
   - 数据库触发器自动增加用户余额
7. 如果拒绝：
   - 更新状态为 'rejected'
   - 余额不变
```

### 提现流程
```
1. 用户在 /dashboard/withdraw 页面输入提现金额
2. 验证余额是否充足
3. 提交提现请求
4. 创建 transactions 记录：
   - type: 'withdraw'
   - status: 'pending'
   - amount: 提现金额
5. 管理员在 /admin/withdrawals 页面查看待审核请求
6. 管理员点击"审核"，选择"批准"或"拒绝"
7. 如果批准：
   - 验证余额是否充足
   - 更新状态为 'approved'
   - 数据库触发器自动扣除用户余额
8. 如果拒绝：
   - 更新状态为 'rejected'
   - 余额不变
```

## 🗄️ 数据库触发器

### 更新后的触发器 (`update_transaction_trigger_for_deposit.sql`)
- **函数**: `process_transaction()`
- **功能**:
  - 当交易状态从 `pending` 变为 `approved` 时：
    - **充值** (`deposit`): 自动增加用户余额
    - **提现** (`withdraw`): 自动扣除用户余额
  - 当状态变为 `rejected` 时：不做任何操作

## 📋 交易状态

所有交易都有三种状态：
- **pending**: 待审核（用户已提交，等待管理员审核）
- **approved**: 已批准（管理员批准，余额已更新）
- **rejected**: 已拒绝（管理员拒绝，余额不变）

## 🔒 权限控制

- **用户端**: 
  - 只能查看自己的交易记录
  - 只能创建自己的充值和提现请求
- **管理员端**: 
  - 可以查看所有用户的交易记录
  - 可以审核所有交易请求

## 📝 重要说明

1. **余额更新**: 由数据库触发器自动处理，确保数据一致性
2. **余额验证**: 
   - 提现时：用户提交时验证一次，管理员批准时再次验证
   - 充值时：无需验证余额
3. **旧的管理员充值功能**: 
   - `rechargeUser` 函数仍然保留，但建议使用新的审核流程
   - 旧功能会直接创建 `approved` 状态的交易记录

## 🧪 测试建议

1. **用户端测试**:
   - 测试充值请求提交
   - 测试提现请求提交（余额充足和不足的情况）
   - 测试查看交易记录
   - 测试不同状态的显示

2. **管理员端测试**:
   - 测试审核充值请求（批准/拒绝）
   - 测试审核提现请求（批准/拒绝）
   - 测试余额更新是否正确
   - 测试查看所有交易记录

3. **数据库触发器测试**:
   - 执行 `update_transaction_trigger_for_deposit.sql`
   - 测试充值批准后余额增加
   - 测试提现批准后余额扣除
   - 测试拒绝后余额不变

## 🚀 下一步

1. **执行数据库迁移**: 在 Supabase Dashboard 中执行 `update_transaction_trigger_for_deposit.sql`
2. **测试完整流程**: 从用户提交到管理员审核的完整流程
3. **移除旧功能**（可选）: 如果不再需要直接充值功能，可以移除 `rechargeUser` 函数
